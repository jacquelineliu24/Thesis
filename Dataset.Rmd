---
title: "Construction of Dataset for Master Thesis Project AY18-19"
author: "Jacqueline Liu and Mhabeni Bona"
date: "28/02/2019"
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

This R notebook documents the dataset construction process for a Master Thesis Project (AY18-19) at the Hertie School of Governance. 

**About the project**: The project is titled, "Sustainable management of Indonesia's forests: Does it matter who owns the land?"

We investigate land use policies and property rights in Indonesia, with respect to forest cover loss. Given Indonesia’s legacy of and tenure grievances, we also conduct a qualitative analysis of the political and social dynamics behind social forestry.   

**Research question**: Does the type of land tenure title affect deforestation rates in Indonesia? What are the mechanisms that facilitate these outcomes?

**Hypothesis**: We posit that land managed by local communities demonstrates lower deforestation rates. Our hypothesis is: Regions managed with social forestry permits (SFPs) will have less forest cover loss than regions not managed with SFPs (i.e. industrial production permits or state forest).

$$H_0 : \beta_{SFP} = \beta_{nonSFP} = 0$$

$$H_1 : \beta_{SFP} \neq \beta_{nonSFP}$$

Besides a map overlay, we test the hypothesis using a difference-in-regression discontinuity (DiRD) design. The main estimation equation is: 

$$\Delta Y_{i}  =  \beta_0  +  \tau (Distance_i)  + \beta_1 (Social_i)  + \epsilon_i $$

## Dataset and sources

We constructed a dataset to contain variables relating to forest cover and rate of forest cover loss (our outcome variable), as well as variables relating to administrative boundaries (predictor) and the relative distance of a pixel to the border of interest (runnning variable). 

The source for the data on forest cover is taken from Hansen et al.'s (2017) global forest cover change dataset: 

Hansen, M. C., P. V. Potapov, R. Moore, M. Hancher, S. A. Turubanova, A. Tyukavina, D. Thau, S. V. Stehman, S. J. Goetz, T. R. Loveland, A. Kommareddy, A. Egorov, L. Chini, C. O. Justice, and J. R. G. Townshend. 2013. “High-Resolution Global Maps of 21st-Century Forest Cover Change.” Science 342 (15 November): 850–53. Data available on-line from: http://earthenginepartners.appspot.com/science-2013-global-forest.

Our main variables are: 

* `treecover2000`: % of treecover recorded by satellite imaging in one pixel. 

* `lossyear`: factor indicating 0 if there was no tree cover loss and taking on values 1 to 17 corresponding to a loss event in years 2001 to 2017. 

* `gain`: factor indicating 0 if there was no tree cover gain and 1 if there was a gain event. Data is only available up to 2012. 

* `pre`: % of treecover at the end of 2008 (pre-treatment).

* `prerate`: % rate of change in forest cover between 2000 and 2008. 

* `post`: % of treecover at the end of 2017 (post-treatment). 

* `postrate`: % rate of change in forest cover between 2009 and 2017. 

* `in_HD`: logical indicating if the pixel is in an SFP permit area or not. 

* `dist`: absolute distance of a pixel from the border of interest. 

* `relativedist`: relative distance of a pixel from the border of interest. Positive values indicate that the pixel is in an SFP permit area, while negative values indicate that the pixel is not in an SFP permit area. 

###Construction of outcome variable: forest cover loss 

```{r Directory, message=FALSE, warning=FALSE, paged.print=FALSE}
# Set working directory
setwd("/Users/jacquelineliu/Desktop/Thesis_Data/Input")

# Load packages
library(sf)
library(ggplot2)
library(rgdal)
library(sp)
library(raster)
source("software/polygonizer.R")
library(spex)
library(dplyr)
library(tidyverse)
library(rgeos)
library(geosphere)
```

```{r Input, message=FALSE, warning=FALSE, paged.print=FALSE}
# Load input
# Load raster layers
treecover <- raster("gfc/treecover2000.tif")
lossyear <- raster("gfc/lossyear.tif")
last <- raster("gfc/last.tif")
gain <- raster ("gfc/gain.tif")
first <- raster("gfc/first.tif")
datamask <- raster("gfc/datamask.tif")

# Load study area polygons 
# (T) Test: Jambi - Tamonarang 
prot <- st_read("Polygons/Jambi_1_GR_Tamonarang_Protection.shp")
prod <- st_read("Polygons/Jambi_1_GR_Tamonarang_Production.shp")
hud <- st_read("Polygons/Jambi_1_GR_Tamonarang_HD.shp")

# (1) Study area 1: Jambi - Tanahabang 
tana.prot <- 
tana.prod <-
tana.hud

```

```{r}
#Set mercator projection
mercator = "+proj=merc +lon_0=0 +k=1 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"
#Corresponding EPSG = 41001
```


####Test area 1: Jambi - Tamonarang 
The following code chunks detail the process for creating the dataset for the test study area near Tamonarang in Jambi Province. 

```{r}
# Create raster stack(s) for study area(s)

# Jambi - Tamonarang 
# Crop raster layers to study area polygons 
# Lossyear
lossyear_prot <- mask(lossyear, mask = prot)
lossyear_prot_crop <- crop(lossyear_prot, prot)
plot(lossyear_prot_crop)

lossyear_hd <- mask(lossyear, mask = hud)
lossyear_hd_crop <- crop(lossyear_hd, hud)

lossyear_tam <- merge(lossyear_prot_crop, lossyear_hd_crop)
plot(lossyear_tam)

# Treecover2000
treecover_prot <- mask(treecover, mask = prot)
treecover_prot_crop <- crop(treecover_prot, prot)

treecover_hd <- mask(treecover, mask = hud)
treecover_hd_crop <- crop(treecover_hd, hud)

treecover_tam <- merge(treecover_prot_crop, treecover_hd_crop)
plot(treecover_tam)

# Gain
gain_prot <- mask(gain, mask = prot)
gain_prot_crop <- crop(gain_prot, prot)

gain_hd <- mask(gain, mask = hud)
gain_hd_crop <- crop(gain_hd, hud)

gain_tam <- merge(gain_prot_crop, gain_hd_crop)
plot(gain_tam)

# Create raster stack and assign projection
crs(lossyear_tam) <- mercator
crs(treecover_tam) <- mercator
crs(gain_tam) <- mercator

forestcover_tam = stack(treecover_tam, lossyear_tam, gain_tam)
head(forestcover_tam)

# Coerce raster to dataframe 
forestcover_tam_df <- as.data.frame(forestcover_tam, xy = TRUE)
sum(is.na(forestcover_tam_df))
forestcover_tam_clean <- na.omit(forestcover_tam_df)
sum(is.na(forestcover_tam_clean))
head(forestcover_tam_clean)
forestcover_tamonarang <- rename(forestcover_tam_clean, c("layer.1" = "treecover2000", "layer.2" = "lossyear", "layer.3" = "gain"))
head(forestcover_tamonarang)

# Save dataframe to drive
saveRDS(forestcover_tamonarang, file = "tamonarang.Rda")
tamonarang <- readRDS("tamonarang.Rda")
head(tamonarang)
```


```{r}
# Creating the predictor and running variables 
# Convert dataframe to sf object
# Changing projection to CRS = 4326 will allow us to plot the land title polygons on top of sf object
tamonarang_sf <- st_as_sf(tamonarang, coords = c("x", "y"), crs = 4326)
head(tamonarang_sf)

plot(tamonarang_sf["treecover2000"], axes = TRUE)
plot(tamonarang_sf["lossyear"], axes = TRUE)
plot(tamonarang_sf["gain"], axes = TRUE)

# Add column for Province
tamonarang_sf$province <- c("Jambi")
head(tamonarang_sf)

plot(st_geometry(tamonarang_sf), col = "forest green", axes = TRUE) 
plot(st_geometry(prot), border = "black", add = TRUE)
plot(st_geometry(hud), border = "black", add = TRUE)

# Create in_HD variable (predictor)
tamonarang_sf$in_HD <- st_intersects(tamonarang_sf, hud, sparse = FALSE)
head(tamonarang_sf)
tamonarang_sf$forest_area_ENG <- c("Protection")
tamonarang_sf$forest_area <- c("Hutan Lindung")
head(tamonarang_sf)

# Identifying the border between polygons 
prot_sp <- as(prot, Class = "Spatial")
hud_sp <- as(hud, Class = "Spatial")

border = st_intersection(prot, hud)
border_sp <- as(border, Class = "Spatial")

# Convert border from polygon to spatial line
border_line <- as(border_sp, Class = "SpatialLines")

# Calculate length of border
SpatialLinesLengths(border_line)
# The border is 5km long

# Checking the plots
plot(st_geometry(tamonarang_sf), col = "forest green", axes = TRUE) 
plot(st_geometry(prot), border = "black", add = TRUE)
plot(st_geometry(hud), border = "black", add = TRUE)
plot(border_line, col = "red", add = TRUE)

# Calculating distance from border 
# Testing with 1 point 
test_matrix <- tamonarang[75000:76000, -(3:5)]
test <- dist2Line(test_matrix, border_line)
summary(test)
test

# Convert tamonarang_sf to dataframe 
tamonarang.df <- as.data.frame(tamonarang_sf, xy = TRUE)

# Create running variable: distrelative
tamonarang.df$distance <- treecovertest1[,1]
tamonarang.df$distrelative <- ifelse(tamonarang.df$in_HD==TRUE, tamonarang.df$distance, -tamonarang.df$distance)
summary(tamonarang.df$distrelative)

y <- tamonarang.df$treecover2000
x <- tamonarang.df$distrelative
z <- tamonarang.df$treecover2017
```


```{r}
# Creating the outcome variable (% rate of forest cover loss)
# Create deforestation variable 
# Deforestation defined as average rate of forest cover loss (2000-2017)
# As mentioned in Puyravaud (2003), we can use average rate of change formula
tamonarang_sf$treecover2017 <- ifelse(tamonarang_sf$lossyear > 0, 0, tamonarang_sf$treecover2000)
tamonarang_sf$rate <- -(tamonarang_sf$treecover2017-tamonarang_sf$treecover2000)/17 

# Calculate forest cover in each year (based on lossyear only)
# testing: doesn't seem to work...
tamonarang.test <- tamonarang.df
for(i in 1:17){
  tamonarang.test$i <- if(tamonarang.test$lossyear == i) {0} 
  else if(tamonarang.test[,(i-1)]==0){0} else{tamonarang.test$treecover2000}
}


# Forest cover pre-2008 and post-2008
tamonarang.df$pre <- ifelse(tamonarang.df$lossyear <= 8, 0, tamonarang.df$treecover2000)
tamonarang.df$post <- ifelse(tamonrang.df$lossyear > 8, 0, tamonrang.df$treecover2000)

tamonarang.df$prerate <- -(tamonarang.df$pre - tamonarang.df$treecover2000)/8
tamonarang.df$postrate <- -(tamonarang.df$post - tamonarang.df$treecover2000)/8

# look into creating a loop for this 
# find out a way to do comparative rdplots year on year (as in Burgess)

# Save dataset to drive 

```


###Study area 1: 

